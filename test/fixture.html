<style>
  body { user-select: none; }
  #fixture { position: fixed; top: 0; left: 0; width: 200px; height: 200px; }
</style>

<div id="fixture"></div>

<script src="../node_modules/chai/chai.js"></script>
<script src="../node_modules/sinon-chai/lib/sinon-chai.js"></script>
<script src="../node_modules/sinon/pkg/sinon.js"></script>
<script>
  var expect = chai.expect

  var el = document.querySelector('#fixture')

  function test(fn, asserts, options, callback) {
    function before() {
      var spies = 'down move up'.split(' ').reduce(function(res, type) {
        res[type] = sinon.spy()
        return res
      }, {})

      for (var k in spies) {
        el.addEventListener('mouse' + k, spies[k])
      }

      var timers = {
        before: Date.now()
      }

      asserts = asserts.bind(null, spies, timers)
    }

    function after() {
      el.parentNode.replaceChild(el.cloneNode(), el)
      el = document.querySelector('#fixture')
    }

    if (!callback) {
      return function() {
        before()
        return fn(options).then(asserts).then(after)
      }
    }

    return function(done) {
      before()
      fn(options, function() {
        asserts()
        after()
        done()
      })
    }
  }

  function flavours(tests) {
    if ('Promise' in window)
      context('with promise flavour', tests)
    context('with callback flavour', tests.bind(null, true))
  }
</script>
